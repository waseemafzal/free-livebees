(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{TZyt:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var r=s("fXoL"),a=s("jhN1");let i=(()=>{class e{constructor(e){this.sanitizer=e}transform(e){const t=new RegExp(/((https?):\/\/((?:www\.|(?!www))[^\s\.\"]+\.[^\s\"]{2,})|(www\.[^\s\"]+\.[^\s\"]{2,}))/g);let s;return s=this.sanitizer.sanitize(r.J.HTML,e),s=e.replace(/</g,"&lt;").replace(/>/g,"&gt;"),s=s.replace(t,(e,...t)=>`<a href="${t[1]?t[1]:"http"}://${t[2]?t[2]:t[3]}" target="_blank">${e}</a>`),this.sanitizer.bypassSecurityTrustHtml(s)}}return e.\u0275fac=function(t){return new(t||e)(r.Mb(a.b))},e.\u0275pipe=r.Lb({name:"parselinks",type:e,pure:!0}),e})()},"Tf/C":function(e,t,s){"use strict";s.d(t,"e",(function(){return i})),s.d(t,"b",(function(){return k})),s.d(t,"f",(function(){return B})),s.d(t,"c",(function(){return F})),s.d(t,"g",(function(){return P})),s.d(t,"a",(function(){return x})),s.d(t,"d",(function(){return N})),s("TZyt");var r=s("N1MX"),a=s("fXoL");let i=(()=>{class e extends r.SettingsManager{constructor(e,t){super(e,t)}getListTemplateType(e){try{switch(this._getString(this.getSections(e),"template",null)){case"GBChatListTemplateTypeSquare":return r.ChatListTemplateType.Square;case"GBChatListTemplateTypeRounded":return r.ChatListTemplateType.Rounded;case"GBChatListTemplateTypeNoPhoto":default:return r.ChatListTemplateType.NoPhoto}}catch(t){return r.ChatListTemplateType.NoPhoto}}getDetailTemplateType(e){try{switch(this._getString(this.getSectionsDetail(e),"template",null)){case"GBChatDetailTemplateTypeSquare":return r.ChatDetailTemplateType.Square;case"GBChatDetailTemplateTypeRounded":return r.ChatDetailTemplateType.Rounded;case"GBChatDetailTemplateTypeNoPhoto":default:return r.ChatDetailTemplateType.NoPhoto}}catch(t){return r.ChatDetailTemplateType.NoPhoto}}getCellSelectedBackgroundColor(e){return this.getColor(this.getSections(e),"cellSelectedBackgroundColor",null,"basic2Color")}getWritingButtonBackgroundColor(e){return this.getColor(this.getSections(e),"writingButtonBackgroundColor",null,"buttonBackgroundColor")}getWritingButtonBackgroundColorGradient(e){return this.getBackgroundColorGradient(this.getSections(e),"writingButtonBackgroundColorGradient",null,"buttonBackgroundColorGradient")}getWritingButtonIconColor(e){return this.getColor(this.getSections(e),"writingButtonIconColor",null,"buttonTextColor")}getDetailDateFont(e){return this.getFont(this.getSectionsDetail(e),"dateFont",null,"primary2Color")}getRecipientBackgroundColor(e){return this.getColor(this.getRecipient(e),"backgroundColor",null,"basic1Color")}getRecipientInfosFontColor(e){return this.getColor(this.getRecipient(e),"infosFontColor",null,"primary3Color")}getRecipientTextFont(e){return this.getFont(this.getRecipient(e),"textFont",null,"primary2Color")}getSenderBackgroundColor(e){return this.getColor(this.getSender(e),"backgroundColor",null,"primary1Color")}getSenderInfosFontColor(e){return this.getColor(this.getSender(e),"infosFontColor",null,"primary4Color")}getSenderTextFont(e){return this.getFont(this.getSender(e),"textFont",null,"primary4Color")}getPostBarBackgroundColor(e){return this.getColor(this.getPostBar(e),"backgroundColor",null,"primary1Color")}getPostBarFieldBackgroundColor(e){return this.getColor(this.getPostBar(e),"fieldBackgroundColor",null,"primary4Color")}getPostBarSendingButtonFont(e){return this.getFont(this.getPostBar(e),"sendingButtonFont",null,"primary4Color")}getPostBarTextFont(e){return this.getFont(this.getPostBar(e),"textFont",null,"primary3Color")}getListRefreshDelay(e){return 1e3*this._getNumber(this.getSections(e),"refreshDelayIOS",20)}getDetailRefreshDelay(e){return 1e3*this._getNumber(this.getSectionsDetail(e),"refreshDelayIOS",2)}getSectionsDefaultThumbImageUrl(e){const t=this.getSectionsDefaultThumb(e);return t?t.imageUrl:Object(r.getStaticAssetFullUrl)("assets/img/gbpreview/defaultAvatar.png")}getSectionsNameFont(e){return this.getFont(this.getSections(e),"nameFont",new r.GBFont({fontType:null,size:0}),"primary2Color")}getRecipient(e){return this._getObject(this.getSectionsDetail(e),"recipient")}getSender(e){return this._getObject(this.getSectionsDetail(e),"sender")}getPostBar(e){return this._getObject(this.getSectionsDetail(e),"postBar")}}return e.\u0275fac=function(t){return new(t||e)(a.Wb(r.LanguagesManager),a.Wb(r.Logger))},e.\u0275prov=a.Ib({token:e,factory:e.\u0275fac}),e})();var n=s("jtHE"),h=s("quSY"),o=s("PqYM"),d=s("z6cu"),c=s("LRne"),l=s("eIep"),u=s("XNiG"),g=s("oB13"),p=s("lJxs"),m=s("JIr8"),b=s("bOdf"),T=s("tk/3"),f=s("wd/R");let S=(()=>{class e{constructor(t){t&&(t instanceof T.g?(this.json=new r.JsonObject(t.body),t.headers.has(e.NEXT_PAGE)&&(this.nextPage=t.headers.get(e.NEXT_PAGE)),t.headers.has(e.TOTAL_COUNT)&&(this.totalCount=Number.parseInt(t.headers.get(e.TOTAL_COUNT)))):t instanceof r.JsonObject&&(this.json=t))}}return e.NEXT_PAGE="X-Next-Page",e.TOTAL_COUNT="X-Total-Count",e})();const M={blacklist:["3"],stat:"ok",items:[{1:{itemId:1,other_user:"1","last-readed":{123456789:5,hide_for:[]},last_message:{id:6,message:"CHAT_FAKE_7",date:f().hour(10).minute(50).toJSON(),from:"1"}}},{2:{itemId:2,other_user:"2","last-readed":{123456789:6,hide_for:[]},last_message:{id:6,from:"2",message:"CHAT_FAKE_14",date:f().hour(10).minute(10).toJSON()}}},{3:{itemId:3,other_user:"3","last-readed":{123456789:1,hide_for:[]},last_message:{id:1,from:"3",message:"CHAT_FAKE_15",date:f().subtract(9,"days").toJSON()}}}]},w={stat:"ok",items:{123456789:{urlPhoto:"[BASE_URL]/assets/img/gbpreview/chatAvatarPlaceholder1.jpg",name:"User Name",userId:123456789,displayName:"User Name"},1:{urlPhoto:"[BASE_URL]/assets/img/gbpreview/chatAvatarPlaceholder4.jpg",name:"Paul",userId:1,displayName:"Paul"},2:{urlPhoto:"[BASE_URL]/assets/img/gbpreview/chatAvatarPlaceholder3.jpg",name:"George",userId:2,displayName:"George"},3:{urlPhoto:"[BASE_URL]/assets/img/gbpreview/chatAvatarPlaceholder2.jpg",name:"John",userId:3,displayName:"John"}}},O=f().subtract(1,"days").hour(14).minute(7),A=f().subtract(1,"days").hour(17).minute(43),C={stat:"ok",1:{messages:[{id:0,from:"1",date:O.toJSON(),message:"CHAT_FAKE_1"},{id:1,from:"123456789",date:O.add(4,"minute").toJSON(),message:"CHAT_FAKE_2"},{id:2,from:"1",date:O.add(2,"minute").toJSON(),message:"CHAT_FAKE_3"},{id:3,from:"123456789",date:f().hour(10).minute(14).toJSON(),message:"CHAT_FAKE_4"},{id:4,from:"1",date:f().hour(10).minute(42).toJSON(),message:"CHAT_FAKE_5"},{id:5,from:"123456789",date:f().hour(10).minute(43).toJSON(),message:"CHAT_FAKE_6"},{id:6,from:"1",date:f().hour(10).minute(50).toJSON(),message:"CHAT_FAKE_7"}]},2:{messages:[{id:7,from:"2",date:A.toJSON(),message:"CHAT_FAKE_8"},{id:8,from:"123456789",date:A.add(4,"minute").toJSON(),message:"CHAT_FAKE_9"},{id:9,from:"2",date:A.add(4,"minute").toJSON(),message:"CHAT_FAKE_10"},{id:10,from:"123456789",date:A.add(1,"minute").toJSON(),message:"CHAT_FAKE_11"},{id:11,from:"2",date:A.add(3,"minute").toJSON(),message:"CHAT_FAKE_12"},{id:12,from:"123456789",date:A.add(2,"minute").toJSON(),message:"CHAT_FAKE_13"},{id:13,from:"2",date:f().hour(10).minute(10).toJSON(),message:"CHAT_FAKE_14"}]},3:{messages:[{id:14,from:"3",date:f().subtract(9,"days").toJSON(),message:"CHAT_FAKE_15"}]}};class y{constructor(e,t){this.settingsManager=e,this.languagesManager=t}blockUser(e){throw new Error("not implemented")}deleteThread(e){throw new Error("not implemented")}getAuthToken(){throw new Error("not implemented")}getItemsByUrl(e){throw new Error("not implemented")}getMessages(e){const t=JSON.parse(JSON.stringify(C[e.id]||C[1]));for(const s in t.messages)t.messages[s].message&&t.messages[s].message.startsWith("CHAT_FAKE")&&(t.messages[s].message=this.languagesManager.getLanguageByKey("GB_TXT_"+t.messages[s].message));return Object(c.a)(new S(new r.JsonObject(t)))}getThreads(){const e=Object.assign({},M);for(const t of e.items)for(const e in t)t[e].last_message&&(t[e].last_message.message=this.languagesManager.getLanguageByKey(t[e].last_message.message));return Object(c.a)(new S(new r.JsonObject(e)))}markThreadAsRead(e){throw new Error("not implemented")}postMessage(e){throw new Error("not implemented")}userListProxy(e){const t=this.settingsManager.getMostAccurateBaseUrl();for(const s in w.items)w.items[s].urlPhoto&&(w.items[s].urlPhoto=w.items[s].urlPhoto.replace("[BASE_URL]",t));return Object(c.a)(new S(new r.JsonObject(w)))}reportSpam(e){throw new Error("not implemented")}}var I=s("pLZG");let U=(()=>{class e{constructor(e,t,s,r){this.authService=e,this.settingsManager=t,this.http=s,this.logger=r,this.retryCount=0,this.setDefaultBaseUrl(),this.idWebzine=this.settingsManager.getIdWebzine(),this.authService.loggedIn.pipe(Object(I.a)(e=>!0===e)).subscribe(()=>{this.currentUser=this.authService.authenticatedUser,this.token=null})}blockUser(e){const t=`${this.baseUrl}/blacklist/${this.idWebzine}/${this.currentUser.unformattedId}/`;let s=(new T.f).set("iduser",e.unformattedId);return this.request(t,"post",s)}deleteThread(e){const t=`${this.baseUrl}/openChatList/${this.idWebzine}/${this.currentUser.unformattedId}/`;let s=(new T.f).set("iduser",e.user.unformattedId);return this.request(t,"post",s)}getAuthToken(){const e=`${this.baseUrl}/authToken/${this.idWebzine}/`;let t=new T.f({encoder:new r.AuthTokenQueryEncoder});t=t.set("credentials",`${this.currentUser.login}:${this.currentUser.pwd}`);let s=new T.e;return s=s.append("Content-Type","application/x-www-form-urlencoded"),this.http.post(e,t.toString(),{headers:s}).pipe(Object(p.a)(e=>(this.logger.debug("Chat API Service response",e),new r.JsonObject(e))),Object(m.a)(e=>(this.logger.error("Chat API Service response",e),Object(d.a)("Chat API service getAuthToken error"))))}getItemsByUrl(e){return this.request(e,"get")}getMessages(e){return this.request(`${this.baseUrl}/oneToOne/${this.idWebzine}/${this.currentUser.unformattedId}/${e.userId}/1/60/`,"get")}getThreads(){return this.request(`${this.baseUrl}/openChatList/${this.idWebzine}/${this.currentUser.unformattedId}/`,"get")}markThreadAsRead(e){return this.request(`${this.baseUrl}/oneToOne/${this.idWebzine}/${this.currentUser.unformattedId}/${e.userId}/1/60/`,"get")}postMessage(e){const t=`${this.baseUrl}/oneToOne/${this.idWebzine}/${this.currentUser.unformattedId}/`+e.otherUser.unformattedId+"/1/60/";let s=(new T.f).set("message",e.message);return this.request(t,"post",s)}userListProxy(e){const t=`${this.baseUrl}/userListProxy/${e.join("/")}/`;return this.request(t,"get")}reportSpam(e){const t=`${this.baseUrl}/spamList/${this.idWebzine}/${e.userId}/`,s=(new T.f).set("iduser",this.authService.authenticatedUser.unformattedId);return this.request(t,"post",s)}getAuthTokenForRequest(){return this.token?Object(c.a)(this.token):this.getAuthToken().pipe(Object(p.a)(t=>{let s=t.getJsonObject(e.ITEM).getString(e.VALUE);return this.token=s,s}))}request(e,t,s=null){return this.getAuthTokenForRequest().pipe(Object(b.a)(r=>{let a=new T.e;a=a.append("X-User-Token",r);let i={headers:a,responseType:"json",observe:"response"};return"post"===t?(a=a.append("Content-Type","application/x-www-form-urlencoded"),i.body=s||null):i.params=s?s.toString():"",this.http.request(t,e,i).pipe(Object(p.a)(e=>(this.logger.debug("Chat API Service response",e.body),new S(e))),Object(m.a)(r=>(this.logger.error("Chat API Service response",r),401===r.status&&this.retryCount<3?(this.token=null,this.retryCount++,this.request(e,t,s)):Object(d.a)("Chat API Service request error"))))}))}setDefaultBaseUrl(){this.baseUrl=e.BASEURL,this.logger.info("Couponing Api Base Url: "+this.baseUrl)}}return e.BASEURL="https://chat.good-api.net",e.ITEM="item",e.VALUE="value",e})(),j=(()=>{class e{}return e.\u0275fac=function(t){return new(t||e)},e.\u0275prov=a.Ib({token:e,factory:function(e){var t,s,i,n,h,o,d=null;return e?d=new e:(t=a.Wb(r.CHAT_MODULE_CONFIG),s=a.Wb(r.AuthService),i=a.Wb(T.b),n=a.Wb(r.LanguagesManager),h=a.Wb(r.Logger),o=a.Wb(r.SettingsManager),d=t.mockData?new y(o,n):new U(s,o,i,h)),d},providedIn:"root"}),e})(),k=(()=>{class e{constructor(e,t,s){this.apiService=e,this.authService=t,this.itemFactory=s,this.lastThreads=new n.a(1),this.lastMessages=new n.a(1),this.allMessages=new n.a(1),this.newMessages=new n.a(1),this.messagesSubscription=new h.a,this.threadsHaveLoaded=!1,this.deletedUsers=new Set,this.markedAsRead=new Map,this.messages=new Map,this.messagesForThread=new Map,this.threads=new Map,this.userIds=new Map,this.users=new Map,this.unreadMessages=new Map}blockUser(e){this.apiService.blockUser(e).subscribe()}clearCache(){this.deletedUsers.clear(),this.markedAsRead.clear(),this.messages.clear(),this.messagesForThread.clear(),this.threads.clear(),this.userIds.clear(),this.users.clear(),this.unreadMessages.clear(),this.lastThreads.complete(),this.allMessages.complete(),this.newMessages.complete(),this.lastThreads=new n.a(1),this.allMessages=new n.a(1),this.newMessages=new n.a(1)}deleteThread(e){this.apiService.deleteThread(e).subscribe()}fetchNextThreads(){return this.getThreadsWithUserInfos(this.nextPage)}threadsWithInterval(e){return Object(o.a)(0,e).pipe(Object(l.a)(()=>this.getThreadsWithUserInfos()))}fetchMessagesByUrl(e,t){this.getMessages(e,t).subscribe(e=>{this.lastMessages.next(e)})}messagesByUrl(e,t){return this.getMessages(e,t)}fetchMessagesWithInterval(e,t){return this.messagesSubscription.unsubscribe(),this.messagesFetcher=Object(o.a)(0,t).pipe(Object(l.a)(()=>this.getMessages(e)),Object(g.a)(new u.a)),this.messagesFetcher.subscribe(this.lastMessages),this.messagesSubscription=this.messagesFetcher.connect(),this.messagesFetcher}getThreadForUser(e){return this.threads.get(e.unformattedId)}markThreadAsRead(e){this.markedAsRead.get(e.id)!==e.lastMessage.id&&(this.markedAsRead.set(e.id,e.lastMessage.id),this.apiService.markThreadAsRead(e).subscribe(),this.removeUnreadThreadMessages(e))}postMessage(t){return this.messagesSubscription.unsubscribe(),this.apiService.postMessage(t).pipe(Object(l.a)(t=>{let s=t.json.getJsonObject(e.LAST_READ).getString(this.authService.authenticatedUser.unformattedId);return this.messagesSubscription=this.messagesFetcher.connect(),[s]}))}userHasThread(e){return this.threads.has(e.unformattedId)}reportSpam(e){return this.apiService.reportSpam(e)}removeUnreadThreadMessages(e,t=!0){this.unreadMessages.get(e.id)&&(this.unreadMessages.delete(e.id),t&&this.newMessages.next(this.unreadMessages))}getMessagesApiResponse(e,t){return t?this.apiService.getItemsByUrl(t):this.apiService.getMessages(e)}getMessagesWithCache(t,s){return t.lastMessage&&this.markedAsRead.set(t.id,t.lastMessage.id),this.getMessagesApiResponse(t,s).pipe(Object(p.a)(a=>{let i=new Array;return a.json.getArray(e.MESSAGES).forEach(s=>{let a,n=new r.JsonObject(s),h=n.getString(e.MESSAGE_ID);if(this.messages.has(h))a=this.messages.get(h);else{a=this.itemFactory.createChatMessage(n),a.otherUser=t.user;let s=n.getString(e.FROM);if(s===this.authService.authenticatedUser.unformattedId)a.author=this.authService.authenticatedUser;else if(this.users.has(s))a.author=this.users.get(s);else{if(!t.user)throw Object(d.a)("Message author not found");a.author=t.user}this.messages.set(h,a);let r=this.messagesForThread.get(t.id);r||(this.messagesForThread.set(t.id,new Array),r=this.messagesForThread.get(t.id)),r.push(a)}i.push(a)}),t.nextPage?s&&(t.nextPage=a.nextPage,t.currentCount+=i.length):(t.nextPage=a.nextPage,t.totalCount=a.totalCount,t.currentCount=i.length),this.allMessages.next(Array.from(this.messages.values())),i}),Object(m.a)(()=>{let e=this.messagesForThread.get(t.id);return e?Object(c.a)(e):Object(c.a)([])}))}getMessages(e,t){return this.getMessagesWithCache(e,t).pipe(Object(p.a)(t=>{let s=new Array;return this.messages.forEach(t=>{t.otherUser===e.user&&s.push(t)}),s}))}getThreadsApiResponse(e){return e?this.apiService.getItemsByUrl(e):this.apiService.getThreads()}getThreadList(t){return this.getThreadsApiResponse(t).pipe(Object(p.a)(s=>{let a=s.json.getArray(e.BLACKLIST),i=new Array;return s.json.getArray(e.ITEMS).forEach(t=>{let s=Object.keys(t),n=new r.JsonObject(t[s[0]]),h=n.getJsonObject(e.LAST_MESSAGE),o=this.itemFactory.createChatMessage(h),d=this.itemFactory.createChatThread(n);d.lastMessage=o;let c=d.userId;if(a.includes(d.userId)&&(d.isBlocked=!0),d.lastMessage.authorId!==this.authService.authenticatedUser.unformattedId){let e,t;e=this.markedAsRead.has(d.id)?this.markedAsRead.get(d.id):d.lastRead.getString(this.authService.authenticatedUser.unformattedId),d.isNew=e!==d.lastMessage.id,this.unreadMessages.has(d.id)?(t=this.unreadMessages.get(d.id),t.has(o.id)||o.id===e||t.add(o.id)):(t=new Set,t.add(o.id)),this.unreadMessages.set(d.id,t),d.isNew||this.removeUnreadThreadMessages(d,!1)}this.deletedUsers.has(c)||(this.users.has(c)?d.user=this.users.get(c):this.userIds.set(c,d.id),this.threads.set(c,d),i.push(d))}),s.nextPage?!t&&this.nextPage||(this.nextPage=s.nextPage):this.threadsHaveLoaded=!0,this.newMessages.next(this.unreadMessages),i}),Object(m.a)(()=>{let e=this.threads;return e?Object(c.a)(Array.from(e.values())):Object(c.a)([])}))}getThreadsWithUserInfos(e){return this.getThreadList(e).pipe(Object(b.a)(e=>{let t=Array.from(this.userIds.keys());return 0===t.length?Object(c.a)(e):this.getUserInfos(t).pipe(Object(p.a)(e=>(e.forEach(e=>{this.threads.has(e.unformattedId)&&(this.threads.get(e.unformattedId).user=e)}),this.userIds.clear(),Array.from(this.threads.values()))))}),Object(p.a)(e=>e.filter(e=>null!==e.user)))}getUserInfos(t){return this.apiService.userListProxy(t).pipe(Object(p.a)(s=>{let r=new Array,a=s.json.getJsonObject(e.ITEMS);return t.forEach(e=>{let t=a.getJsonObject(e);if(t){let s=this.itemFactory.createUser(t);this.users.set(e,s),r.push(s)}else this.deletedUsers.add(e)}),r}))}}return e.BLACKLIST="blacklist",e.FROM="from",e.LAST_READ="last-readed",e.LAST_MESSAGE="last_message",e.MESSAGE_ID="id",e.ITEMS="items",e.MESSAGES="messages",e.\u0275fac=function(t){return new(t||e)(a.Wb(j),a.Wb(r.AuthService),a.Wb(r.GBItemFactory))},e.\u0275prov=a.Ib({token:e,factory:e.\u0275fac,providedIn:"root"}),e})();var v=s("VRyK"),E=s("Kqap"),_=s("vkgz");let B=(()=>{class e{constructor(e,t,s){this.dataManager=e,this.itemFactory=t,this.platform=s,this.currentThread=new n.a(1),this.markAsRead=new u.a,this.deletedThread=new u.a,this.blockedThread=new u.a,this.unblockedThread=new u.a,this.createThread=new u.a,this.newThreads=new u.a,this.updatedThread=new u.a,this.reportedThread=new u.a,this.changeThread=new u.a,this.askedForThreadReport=new u.a,this.threadActionListOpenedIndex=new u.a,this.threadActionListOpened=!1,this.browserTabUpdate=new u.a,this.updatesOnThreads=new u.a,this.internThreads=new Array,this.selected=null,this.threads=this.updatesOnThreads.pipe(Object(E.a)((e,t)=>this.internThreads=t(e),this.internThreads)),this.createThread.pipe(Object(_.a)(this.setSelectedThread.bind(this)),Object(p.a)(e=>(e.status=3,t=>t.concat(e)))).subscribe(this.updatesOnThreads),this.newThreads.subscribe(this.createThread),this.deletedThread.pipe(Object(_.a)(e=>this.dataManager.deleteThread(e)),Object(p.a)(e=>(e.status=2,e=>e))).subscribe(this.updatesOnThreads),Object(v.a)(this.blockedThread,this.unblockedThread).subscribe(e=>this.dataManager.blockUser(e.user)),this.blockedThread.pipe(Object(p.a)(e=>(e.isBlocked=!0,e.status=4,e=>e))).subscribe(this.updatesOnThreads),this.unblockedThread.pipe(Object(p.a)(e=>(e.isBlocked=!1,e.status=5,e=>e))).subscribe(this.updatesOnThreads),this.updatedThread.pipe(Object(_.a)(this.setSelectedThread.bind(this)),Object(p.a)(e=>(e.status=1,e=>e))).subscribe(this.updatesOnThreads),Object(v.a)(this.deletedThread,this.blockedThread).pipe(Object(I.a)(()=>!this.platform.isMobileSize())).subscribe(e=>{if(!this.selected||e.userId===this.selected.userId){const t=this.internThreads.sort(this.reverseChronologicallySort.bind(this)).find(t=>e!==t&&2!==t.status&&!t.isBlocked);t&&this.setSelectedThread(t)}}),this.reportedThread.subscribe(this.blockedThread)}get orderedList(){return this.getOrderedThreads()}get selectedThread(){return this.selected}initCurrentThreadSubscription(){const e=this.markAsRead.pipe(Object(_.a)(e=>this.dataManager.markThreadAsRead(e))),t=this.currentThread.pipe(Object(_.a)(e=>this.dataManager.removeUnreadThreadMessages(e)),Object(p.a)(e=>this.selected=e));Object(v.a)(t,e).pipe(Object(p.a)(e=>(e.isNew=!1,e.status=1,e=>e))).subscribe(this.updatesOnThreads)}resetCurrentThreadSubscription(){this.currentThread.complete(),this.currentThread=new n.a(1)}setSelectedThread(e){!e||this.selected&&(e.isBlocked||e.userId===this.selected.userId)||this.currentThread.next(e)}deselectThread(){this.selected=null}toggleBlockThread(e){e.isBlocked?this.unblockThread(e):this.blockThread(e)}blockThread(e){this.blockedThread.next(e)}unblockThread(e){this.unblockedThread.next(e)}deleteThread(e){this.deletedThread.next(e)}addThread(e){this.newThreads.next(e)}markThreadAsRead(e){this.markAsRead.next(e)}askForReportThreadAsSpam(e){this.askedForThreadReport.next(e)}reportThreadAsSpam(e){return this.reportedThread.next(e),this.dataManager.reportSpam(e)}updateThread(e,t){e.date=t.date,e.lastMessage=t,this.updatedThread.next(e)}getThreadByUser(e){return this.internThreads.find(t=>t.userId===e)}openingActionsList(e){this.threadActionListOpenedIndex.next(e),this.threadActionListOpened=!!e}getMessageHistory(e){const t=this.getThreadByUser(e.unformattedId);if(t&&3!==t.status)return this.setSelectedThread(t),t;{const t=this.itemFactory.createChatThread(new r.JsonObject({other_user:e.unformattedId,"last-readed":{}}));return t.user=e,this.platform.isPreviewApp||this.addThread(t),t}}initLastThreadSubscription(){this.lastThreadsSubscription=this.dataManager.lastThreads.pipe(Object(p.a)(e=>t=>this.mergeLocalRemoteThreads(t,e))).subscribe(this.updatesOnThreads)}clearCache(){this.internThreads=new Array}getOrderedThreads(e=!0){const t=e?this.reverseChronologicallySort.bind(this):this.chronologicallySort.bind(this);return this.threads.pipe(Object(p.a)(e=>e.filter(e=>2!==e.status&&3!==e.status).filter((e,t,s)=>s.findIndex(t=>t.userId===e.userId)===t).sort(t)))}reverseChronologicallySort(e,t){return-1*this.chronologicallySort(e,t)}chronologicallySort(e,t){return e.isBlocked&&!t.isBlocked?-1:t.isBlocked&&!e.isBlocked?1:new Date(e.date).getTime()-new Date(t.date).getTime()}mergeLocalRemoteThreads(e,t){const s=t.map(t=>{t.status=0;const s=e.find(e=>e.userId===t.userId);if(!s)return t;{const e=this.selected&&this.selected.userId===s.userId;switch(s.status){case 2:return null;case 4:return t.isBlocked?t:s;case 5:return t.isBlocked?s:t;case 1:return new Date(s.lastMessage.date).getTime()<new Date(t.lastMessage.date).getTime()?e?(s.date=t.date,s.lastMessage=t.lastMessage,s):t:s;case 3:case 0:default:return t}}});let r=[];return e.length>s.length&&(r=e.map(e=>s.find(t=>t.userId===e.userId)?null:e)),s.concat(r).filter(e=>null!==e)}}return e.\u0275fac=function(t){return new(t||e)(a.Wb(k),a.Wb(r.GBItemFactory),a.Wb(r.PlatformService))},e.\u0275prov=a.Ib({token:e,factory:e.\u0275fac}),e})(),F=(()=>{class e{constructor(e,t,s,a,i){this.authenticationManager=e,this.dataManager=t,this.itemFactory=s,this.threadsManager=a,this.platform=i,this.createMessage=new u.a,this.flagMessageUpdate=new u.a,this.flagMessageError=new u.a,this.lastMessagesSubscription=new h.a,this.updatesOnMessages=new u.a,this.internMessages=new Array,e.loggedIn.pipe(Object(I.a)(()=>!this.platform.isPreviewApp)).subscribe(e=>{t.clearCache(),this.updatesOnMessages=new u.a,this.internMessages=new Array,a.clearCache(),this.initMergeSubscription()}),this.messages=this.updatesOnMessages.pipe(Object(p.a)(e=>this.internMessages=e)),this.selectedThreadMessages=this.messages.pipe(Object(p.a)(e=>this.threadsManager.selectedThread&&2!==this.threadsManager.selectedThread.status&&!this.threadsManager.selectedThread.isBlocked?e.filter(e=>e.otherUser.unformattedId===this.threadsManager.selectedThread.userId):[])),this.threadsManager.deletedThread.pipe(Object(p.a)(()=>this.internMessages)).subscribe(this.updatesOnMessages),this.initMergeSubscription(),this.createMessage.pipe(Object(_.a)(this.messageShouldCreateThread.bind(this)),Object(p.a)(e=>(e.status=r.MESSAGE_STATUS.PENDING,this.internMessages.includes(e)?this.internMessages:this.internMessages.concat(e)))).subscribe(this.updatesOnMessages);const n=this.flagMessageUpdate.pipe(Object(p.a)(e=>e.status=r.MESSAGE_STATUS.UPDATED)),o=this.flagMessageError.pipe(Object(p.a)(e=>e.status=r.MESSAGE_STATUS.ERROR));Object(v.a)(n,o).pipe(Object(p.a)(()=>this.internMessages)).subscribe(this.updatesOnMessages)}initChatDetailRefresh(e){return this.threadsManager.currentThread.pipe(Object(l.a)(t=>this.initMessagesGetter(t,e)))}initMergeSubscription(){this.dataManager.lastMessages.pipe(Object(p.a)(e=>this.mergeLocalRemoteMessage(this.internMessages,e))).subscribe(this.updatesOnMessages)}addMessage(e,t){const s=new Date,a=this.authenticationManager.authenticatedUser,i=this.itemFactory.createChatMessage(new r.JsonObject({id:"mssg"+s.getTime(),date:s.toString(),message:t,from:a.unformattedId}));i.author=a,i.otherUser=e,this.createMessage.next(i)}get currentThreadMessages(){return this.selectedThreadMessages.pipe(Object(p.a)(e=>{let t=new Array;return e.forEach((e,s)=>{const r=f(new Date(e.date).toISOString()).format("YYYY-MM-DD");let a=t.find(e=>e.date===r);a||(a=this.itemFactory.createChatMessageGroup(r)),a.messages.push(e),t.indexOf(a)<0&&t.push(a)}),t.map(e=>{let t;return e.messages=e.messages.sort(this.sortByDate.bind(this)).map((s,r)=>(s.showAvatar=!1,t&&t.authorId!==s.authorId&&(t.showAvatar=!0),r===e.messages.length-1&&(s.showAvatar=!0),t=s,s)),e}).sort(this.sortByDate.bind(this))}),Object(_.a)(e=>{if(e&&e.length>0){const t=e[e.length-1].messages;if(t){const e=t[t.length-1];(!this.threadsManager.selectedThread.lastMessage||e&&e.date>this.threadsManager.selectedThread.lastMessage.date)&&this.threadsManager.updateThread(this.threadsManager.selectedThread,e)}}}))}get unselectedThreadsUnreadMessagesCounter(){return this.dataManager.newMessages.pipe(Object(p.a)(e=>{let t=0;return e.forEach((e,s)=>{this.threadsManager.selectedThread&&s!==this.threadsManager.selectedThread.id&&(t+=e.size)}),t}))}get allThreadsUnreadMessagesCounter(){return this.dataManager.newMessages.pipe(Object(p.a)(e=>{let t=0;return e.forEach(e=>t+=e.size),t}))}messageShouldCreateThread(e){this.dataManager.postMessage(e).subscribe(t=>{e.id=t,this.flagMessageUpdate.next(e)},t=>this.flagMessageError.next(e));const t=this.threadsManager.getThreadByUser(e.otherUser.unformattedId);if(t)this.threadsManager.updateThread(t,e);else{const t=this.itemFactory.createChatThread(new r.JsonObject({other_user:e.otherUser.unformattedId,"last-readed":{}}));t.lastMessage=e,t.user=e.otherUser,this.threadsManager.addThread(t)}}initMessagesGetter(e,t){this.lastMessagesSubscription.unsubscribe();const s=this.dataManager.fetchMessagesWithInterval(e,t);return this.lastMessagesSubscription=s.connect(),s}mergeLocalRemoteMessage(e,t){let s=[];return e.length>t.length&&(s=e.map(e=>t.find(t=>t.id===e.id)?null:e)),t.concat(s).filter(e=>null!==e)}sortByDate(e,t){return new Date(e.date).getTime()-new Date(t.date).getTime()}}return e.\u0275fac=function(t){return new(t||e)(a.Wb(r.AuthService),a.Wb(k),a.Wb(r.GBItemFactory),a.Wb(B),a.Wb(r.PlatformService))},e.\u0275prov=a.Ib({token:e,factory:e.\u0275fac}),e})();var L=s("Kj3r"),R=s("/uUt");let P=(()=>{class e{constructor(e,t,s){this.authService=e,this.threadsService=t,this.userApi=s,this.search=new u.a}getAllUsers(){return this.userApi.searchUser("").pipe(Object(p.a)(e=>e.filter(e=>e.allowContact&&e.id!==this.authService.authenticatedUser.id).sort(this.alphabeticalOrder)))}getDefaultUsers(){const e=this.threadsService.internThreads.filter(e=>3!==e.status).filter((e,t,s)=>s.findIndex(t=>t.userId===e.userId)===t).filter(e=>!e.isBlocked);return e.length?Object(c.a)(e.map(e=>e.user).sort(this.alphabeticalOrder)):this.getAllUsers()}searchUsers(){return this.search.pipe(Object(L.a)(300),Object(R.a)(),Object(l.a)(e=>e&&e.length>0?this.userApi.searchUser(e).pipe(Object(p.a)(e=>e.filter(e=>e.allowContact&&e.id!==this.authService.authenticatedUser.id))):this.getDefaultUsers()),Object(p.a)(e=>e.sort(this.alphabeticalOrder)))}alphabeticalOrder(e,t){return e.name.toLowerCase()<t.name.toLowerCase()?-1:e.name.toLowerCase()>t.name.toLowerCase()?1:0}}return e.\u0275fac=function(t){return new(t||e)(a.Wb(r.AuthService),a.Wb(B),a.Wb(r.UsersApiService))},e.\u0275prov=a.Ib({token:e,factory:e.\u0275fac}),e})();const x=[{provide:r.SettingsManager,useExisting:i},r.LoadMoreManager];s("awbG");let N=(()=>{class e{constructor(e,t){this.messagesService=e,this.threadsService=t,this.messageSent=new u.a,this.selectedUser=new u.a,this.selectedThread=new u.a}selectUser(e){this.selectedUser.next(e),this._selectedUser=e;const t=this.threadsService.getMessageHistory(e);this.selectedThread.next(t)}sendMessage(e){return!!this._selectedUser&&(this.messagesService.addMessage(this._selectedUser,e),this.messageSent.next(null),!0)}unselectUser(){this.selectedUser.next(null),this._selectedUser=null,this.selectedThread.next(null)}}return e.\u0275fac=function(t){return new(t||e)(a.Wb(F),a.Wb(B))},e.\u0275prov=a.Ib({token:e,factory:e.\u0275fac}),e})()},awbG:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var r=s("3UWI"),a=s("fXoL"),i=s("N1MX");let n=(()=>{class e{constructor(e){this.scrollableElement=e,this.lastScrollHeight=0,this.lastScrollTop=0,this.locked=!1}ngAfterViewInit(){this.scrollableElement.scrollTop=this.scrollableElement.scrollHeight;let e=this.scrollableElement.elementScrolled().pipe(Object(r.a)(100));this.scrollSubscription=e.subscribe(e=>{this.lastScrollHeight=e.scrollHeight,this.lastScrollTop=e.scrollTop,this.locked=e.scrollHeight-e.offsetHeight-e.scrollTop>300}),this.mutationObserver=new MutationObserver(()=>{this.scrollableElement.scrollTop=this.locked?this.lastScrollTop-this.lastScrollHeight+this.scrollableElement.scrollHeight:this.scrollableElement.scrollHeight}),this.mutationObserver.observe(this.scrollableElement.nativeElement,{childList:!0,subtree:!0})}ngOnChanges(e){e.thread&&(this.locked=!1)}ngOnDestroy(){this.scrollSubscription&&this.scrollSubscription.unsubscribe(),this.mutationObserver.disconnect()}}return e.\u0275fac=function(t){return new(t||e)(a.Mb(i.ScrollableDirective))},e.\u0275dir=a.Hb({type:e,selectors:[["","gbChatAutoscroll",""]],inputs:{thread:"thread"},features:[a.yb]}),e})()}}]);
//# sourceMappingURL=7-es2015.a947af6d0521ed11199d.js.map